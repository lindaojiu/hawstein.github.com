
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>GreenHat's Blog</title>
    <meta name="author" content="GreenHat" />
    <link href="http://gangliao.me/blog.html"
    rel="alternate" title="GreenHat's Blog" type="application/atom+xml" />

    <!-- Homepage CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="/assets/css/bootstrap-responsive.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="/assets/css/app.css" type="text/css" media="screen" charset="utf-8" />

    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

    <!-- syntax highlighting CSS -->
    <link rel="stylesheet" href="/assets/css/syntax.css" type="text/css" media="screen" charset="utf-8" />

    <link rel="shortcut icon" href="/assets/ico/favicon.ico">
      <!-- Fonts -->
      <link href='http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz' rel='stylesheet' type='text/css'>
      </head>

      <body>
  <div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="/blog.html">GreenHat's Blog</a>
  <ul class="nav">
    <li class="active"><a href="/blog.html">Home</a></li>
    <li ><a href="/archive.html">Archive</a></li>
    <li ><a href="/categories.html">Categories</a></li>
    <li ><a href="/sitemap.html">Sitemap</a></li>
    <li ><a href="/about.html">About</a></li>
  </ul>
  <ul class="nav pull-right">
    <li ><a href="/atom.xml">Subscribe</a></li>
  </ul>
    </div>
  </div>
</div>

  <div class="container">
    <h1> GreenHat's Blog</h1>
<div style="line-height:180%;">
    作者：GreenHat<br>
    主页：<a href="http://gangliao.me">gangliao.me</a><br>
    出处：<a href="/blog.html">gangliao.me/blog</a><br>
    声明：转载请注明作者及出处。<br><br>
</div>

<h1> Newest 10 Posts</h1>
<ul class="posts">

    <li><span class="post_date">November 20, 2014</span> &raquo; <a href="/posts/Thrust-Passing-device_vector-to-Kernel.html">Thrust -  Passing device_vector to Kernel</a></li>

    <li><span class="post_date">November 17, 2014</span> &raquo; <a href="/posts/Parallel-Suffix-Array-on-GPU.html">Dynamic Parallel Skew Algorithm for Suffix Array on GPU</a></li>

    <li><span class="post_date">November 15, 2014</span> &raquo; <a href="/posts/vim-tutorials.html">Vim Tutorials</a></li>

    <li><span class="post_date">November 14, 2014</span> &raquo; <a href="/posts/how-to-write-paper.html">How to write a great research paper</a></li>

    <li><span class="post_date">November 13, 2014</span> &raquo; <a href="/posts/markdown-syntax.html">Markdown Syntax</a></li>

    <li><span class="post_date">November 12, 2014</span> &raquo; <a href="/posts/Parallel-Computing-Bootcamp.html">Parallel Computing BootCamp</a></li>

    <li><span class="post_date">January 20, 2014</span> &raquo; <a href="/posts/google-java-style.html">Google Java编程风格指南</a></li>

    <li><span class="post_date">February  1, 2013</span> &raquo; <a href="/posts/12.6.html">Cracking the coding interview--Q12.6</a></li>

    <li><span class="post_date">January 31, 2013</span> &raquo; <a href="/posts/12.5.html">Cracking the coding interview--Q12.5</a></li>

    <li><span class="post_date">January 30, 2013</span> &raquo; <a href="/posts/12.4.html">Cracking the coding interview--Q12.4</a></li>

</ul>



<div id="post">
<h1> <a href = "/posts/Thrust-Passing-device_vector-to-Kernel.html">
    Newest Post - Thrust -  Passing device_vector to Kernel
</a></h1>




<div class="authoring">
  November 20, 2014
</div>

<p>Thrust makes it convenient to handle data with its <code>device_vector</code>. But, things get messy
when the <code>device_vector</code> needs to be passed to your own kernel. Thrust data types are not
understood by the kernel and need to be converted back to its underlying pointer. This is done using <code>thrust::raw_pointer_cast</code>:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include &lt;thrust/device_vector.h&gt;</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="n">iVec</span><span class="p">;</span>
<span class="kt">int</span> <span class="o">*</span><span class="n">iArray</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">::</span><span class="n">raw_pointer_cast</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">iVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
<span class="n">fooKernel</span><span class="o">&lt;&lt;&lt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">&gt;&gt;&gt;</span><span class="p">(</span> <span class="n">iArray</span> <span class="p">);</span></code></pre></div>


<p>Inside any kernel, one frequently needs not just a pointer to the array,
but also the length of the array. Thus, it is useful to <code>convert device_vector</code>
to a structure that holds both a pointer to the array and its length. Creating
such a structure and its conversion function is easy thanks to templates:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="c1">// Template structure to pass to kernel</span>
<span class="k">template</span> <span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">KernelArray</span>
<span class="p">{</span>
    <span class="n">T</span><span class="o">*</span>  <span class="n">_array</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">_size</span><span class="p">;</span>
 <span class="p">};</span>

<span class="c1">// Function to convert device_vector to structure</span>
<span class="k">template</span> <span class="o">&lt;</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">&gt;</span>
<span class="n">KernelArray</span><span class="o">&lt;</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="n">convertToKernel</span><span class="p">(</span> <span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span> <span class="n">T</span> <span class="o">&gt;&amp;</span> <span class="n">dVec</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="n">KernelArray</span><span class="o">&lt;</span> <span class="n">T</span> <span class="o">&gt;</span> <span class="n">kArray</span><span class="p">;</span>
    <span class="n">tArray</span><span class="p">.</span><span class="n">_array</span> <span class="o">=</span> <span class="n">thrust</span><span class="o">::</span><span class="n">raw_pointer_cast</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">dVec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">);</span>
    <span class="n">tArray</span><span class="p">.</span><span class="n">_size</span>  <span class="o">=</span> <span class="p">(</span> <span class="kt">int</span> <span class="p">)</span> <span class="n">dVec</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">kArray</span><span class="p">;</span>
 <span class="p">}</span></code></pre></div>


<p>Passing <code>device_vector</code> to kernels and accessing its array inside the kernel is easy thanks to this infrastructure:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="n">iVec</span><span class="p">;</span>
<span class="n">fooKernel</span><span class="o">&lt;&lt;&lt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">&gt;&gt;&gt;</span><span class="p">(</span> <span class="n">convertToKernel</span><span class="p">(</span> <span class="n">iVec</span> <span class="p">)</span> <span class="p">);</span> <span class="c1">// Explicit conversion from iVec to KernelArray&lt; int &gt;</span>
<span class="n">__global__</span> <span class="nf">fooKernel</span><span class="p">(</span> <span class="n">KernelArray</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="n">inArray</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">inArray</span><span class="p">.</span><span class="n">_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
        <span class="n">something</span> <span class="o">=</span> <span class="n">inArray</span><span class="p">.</span><span class="n">_array</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>
        <span class="c1">// ...</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>


<p>You can take it a notch higher and make the conversion from <code>device_vector</code> to <code>KernelArray</code>
to be implicit. This can be done by adding a constructor to <code>KernelArray</code> that takes one
input parameter of type <code>device_vector</code>. With such a constructor, you can now pass
a <code>device_vector</code> seamlessly to the kernel:</p>

<div class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="n">iVec</span><span class="p">;</span>
<span class="n">fooKernel</span><span class="o">&lt;&lt;&lt;</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">&gt;&gt;&gt;</span><span class="p">(</span> <span class="n">iVec</span> <span class="p">);</span> <span class="c1">// Implicit conversion from iVec to KernelArray&lt; int &gt;</span>
<span class="n">__global__</span> <span class="nf">fooKernel</span><span class="p">(</span> <span class="n">KernelArray</span><span class="o">&lt;</span> <span class="kt">int</span> <span class="o">&gt;</span> <span class="n">inArray</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span></code></pre></div>




</div>



    <div id="footer">
  Powered by Last updated at 2014-11-20 21:33:20 +0000.
</div>

  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
  <script src="/assets/js/app.js"></script>
  <script type="text/javascript">


  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-37837952-1']);
  _gaq.push(['_trackPageview']);


  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();


</script>

      </body>
</html>
